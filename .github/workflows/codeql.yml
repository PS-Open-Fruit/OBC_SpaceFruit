name: STM32 MISRA C Check

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  misra-analysis:
    name: MISRA C Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write # Required for the Security Tab report
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run Cppcheck (MISRA Only)
        run: |
          # 1. Create misra.json config
          echo '{
              "script": "misra.py",
              "args": ["--rule-texts="]
          }' > misra.json

          # 2. Run Scan
          # --addon=misra.json : Enables MISRA checks
          # --suppress=*:*PythonLib/* : Explicitly ignore your Python folder (optional extra safety)
          # We REMOVED "--enable=all" to avoid generic "style" suggestions.
          # We keep standard "errors" (critical bugs) because they are often MISRA violations too.
          
          cppcheck --addon=misra.json \
                   --inline-suppr \
                   --suppress=missingIncludeSystem \
                   --force \
                   --xml --xml-version=2 \
                   Core/Src Drivers/STM32L4xx_HAL_Driver/Src Middlewares/ST/STM32_USB_Device_Library USB_DEVICE obc-drivers \
                   2> cppcheck_report.xml

      - name: Convert to SARIF
        uses: ssd-secure-disclosure/artifact-converter@v1
        with:
          converter: cppcheck
          input_path: cppcheck_report.xml
          output_path: cppcheck_report.sarif

      - name: Upload Result to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: cppcheck_report.sarif
          category: cppcheck
