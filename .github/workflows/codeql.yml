name: STM32 MISRA C Check

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  misra-analysis:
    name: MISRA C Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    # 1. Run inside a Docker container to get the absolute latest Cppcheck
    container:
      image: neszt/cppcheck:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Cppcheck (With Includes)
        run: |
          # Configure MISRA
          echo '{
              "script": "misra.py",
              "args": ["--rule-texts="]
          }' > misra.json

          # Run Scan
          # -I OBC_STM32/Core/Inc : TELLS CPPCHECK WHERE main.h IS
          # --suppress=*:*Drivers/* : Ignores the HAL drivers (focus on YOUR code)
          
          cppcheck --addon=misra.json \
                   --inline-suppr \
                   --suppress=missingIncludeSystem \
                   --force \
                   --xml --xml-version=2 \
                   --output-file=cppcheck_report.xml \
                   -I OBC_STM32/Core/Inc \
                   OBC_STM32/Core

      # 2. Install Node.js (Required for the converter action below)
      - name: Install Node.js
        run: apk add --no-cache nodejs npm

      - name: Convert to SARIF
        uses: Flast/cppcheck-sarif@v2
        with:
          input: cppcheck_report.xml
          output: cppcheck_report.sarif

      - name: Upload Result to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: cppcheck_report.sarif
          category: cppcheck
