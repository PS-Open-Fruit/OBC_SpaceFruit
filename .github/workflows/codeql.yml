name: STM32 MISRA C Check

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  misra-analysis:
    name: MISRA C Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run Cppcheck (MISRA Only)
        run: |
          # 1. Create misra.json config to suppress the need for copyright rule texts
          echo '{
              "script": "misra.py",
              "args": ["--rule-texts="]
          }' > misra.json

          # 2. Run Scan
          # --output-file: Writes the XML directly to a file (cleaner than using 2>)
          # --addon=misra.json: Enables MISRA checks
          # We check Core/Src (User code) and Drivers (HAL)
          
          cppcheck --addon=misra.json \
                   --inline-suppr \
                   --suppress=missingIncludeSystem \
                   --force \
                   --xml --xml-version=2 \
                   --output-file=cppcheck_report.xml \
                   OBC_STM32/Core OBC_STM32/Drivers/

      - name: Convert to SARIF
        # FIXED: Using a currently active converter action
        uses: Flast/cppcheck-sarif@v2
        with:
          input: cppcheck_report.xml
          output: cppcheck_report.sarif

      - name: Upload Result to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: cppcheck_report.sarif
          category: cppcheck
