name: STM32 MISRA C Check

on:
  push:
    branches: [ "main", "master" ]

jobs:
  misra-analysis:
    name: MISRA C Analysis
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck
          cppcheck --version

      - name: Run Cppcheck (MISRA Only)
        run: |
          # 1. Create misra.json config
          echo '{
              "script": "misra.py",
              "args": ["--rule-texts="]
          }' > misra.json

          # 2. Run Scan
          # -I: Points to your Include folder so Cppcheck finds main.h
          # --suppress: We ignore the HAL drivers to focus on your bugs
          
          cppcheck --addon=misra.json \
                   --inline-suppr \
                   --suppress=missingIncludeSystem \
                   --force \
                   --xml --xml-version=2 \
                   --output-file=cppcheck_report.xml \
                   -I OBC_STM32/Core/Inc \
                   OBC_STM32/Core

      - name: Convert to SARIF
        uses: Flast/cppcheck-sarif@v2
        with:
          input: cppcheck_report.xml
          output: cppcheck_report.sarif

      - name: Upload Result to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: cppcheck_report.sarif
          category: cppcheck
